<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>地震情報</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background-color: #fff;
    }
    .section {
      background: #fff;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: none;
      position: relative;
      z-index: 1;
    }
    #infoContainer p {
      margin: 0 0 10px;
      color: #333;
    }
    .intensity-group {
      margin-top: 10px;
    }
    .intensity {
      font-weight: bold;
      color: #d9534f;
    }
    .pref, .area {
      margin-left: 20px;
    }
  </style>
</head>
<body>
  <div id="infoContainer" class="section"></div>

  <script>
    let lastJsonFile = "";

    async function fetchLatestQuakeData() {
      try {
        const listRes = await fetch('https://www.jma.go.jp/bosai/quake/data/list.json');
        const listData = await listRes.json();
        const latestJsonFile = listData[0].json;

        if (latestJsonFile === lastJsonFile) return;
        lastJsonFile = latestJsonFile;

        const quakeRes = await fetch(`https://www.jma.go.jp/bosai/quake/data/${latestJsonFile}`);
        const quakeData = await quakeRes.json();

        const container = document.getElementById("infoContainer");
        let html = "";

        const control = quakeData.Control;
        const head = quakeData.Head;
        const body = quakeData.Body;
        const eq = body?.Earthquake;
        const int = body?.Intensity?.Observation;

        if (head?.InfoKind) {
          html += `<h1><strong>${head.InfoKind}</strong></h1>`;
        }

        if (control?.Title) {
          html += `<p><strong>詳細情報:</strong> ${control.Title}</p>`;
        }

        if (control?.EditorialOffice) {
          html += `<p><strong>編集官署:</strong> ${control.EditorialOffice}</p>`;
        }

        if (head?.InfoType && head?.Serial) {
          html += `<p><strong>情報種別:</strong> ${head.InfoType} ${head.Serial}</p>`;
        }

        if (eq?.Hypocenter?.Area?.Name) {
          html += `<p><strong>震源地:</strong> ${eq.Hypocenter.Area.Name}</p>`;
        }

        if (eq?.Hypocenter?.Area?.Code) {
          html += `<p><strong>震央コード:</strong> ${eq.Hypocenter.Area.Code}</p>`;
        }

        if (int?.MaxInt) {
          html += `<p><strong>最大震度:</strong> ${int.MaxInt}</p>`;
        }

        if (eq?.Magnitude) {
          html += `<p><strong>マグニチュード:</strong> ${eq.Magnitude}</p>`;
        }

        let lat = "不明", lon = "不明";
        const coordMatch = eq?.Hypocenter?.Area?.Coordinate?.match(/\+([0-9.]+)\+([0-9.]+)(-?[0-9]+)/);
        if (coordMatch) {
          lat = coordMatch[1];
          lon = coordMatch[2];
          html += `<p><strong>座標:</strong> 緯度 ${lat} / 経度 ${lon}</p>`;
        }

        let depth = "";
        if (coordMatch) {
          depth = Math.abs(parseInt(coordMatch[3], 10)) / 1000;
          html += `<p><strong>深さ:</strong> ${depth} km</p>`;
        }

        if (eq?.OriginTime) {
          html += `<p><strong>発生時刻:</strong> ${new Date(eq.OriginTime).toLocaleString()}</p>`;
        }

        if (head?.Headline?.Text) {
          html += `<p><strong>コメント:</strong> ${head.Headline.Text}</p>`;
        }

        if (body?.Comments?.ForecastComment?.Text) {
          html += `<p><strong>津波情報:</strong> ${body.Comments.ForecastComment.Text}</p>`;
        }

        if (control?.PublishingOffice) {
          html += `<p><strong>提供元:</strong> ${control.PublishingOffice}</p>`;
        }

        if (int?.Pref) {
          html += `<h2><strong>各地の震度情報</strong></h2>`;
          const intensityGroups = {};

          int.Pref.forEach(pref => {
            if (pref.Area) {
              pref.Area.forEach(area => {
                const intensity = area.MaxInt;
                if (!intensityGroups[intensity]) {
                  intensityGroups[intensity] = [];
                }
                intensityGroups[intensity].push({
                  prefName: pref.Name,
                  areaName: area.Name
                });
              });
            }
          });

          const intensityOrder = ['7', '6強', '6弱', '5強', '5弱', '4', '3', '2', '1', '不明'];

          intensityOrder.forEach(intensity => {
            if (intensityGroups[intensity]) {
              html += `<div class="intensity-group">
                         <p class="intensity">最大震度 ${intensity}</p>`;
              intensityGroups[intensity].forEach(item => {
                html += `<p class="pref">${item.prefName} - ${item.areaName}</p>`;
              });
              html += `</div>`;
            }
          });
        }

        container.innerHTML = html;
        container.style.display = "block";

      } catch (err) {
        const container = document.getElementById("infoContainer");
        container.innerHTML = "エラー: " + err.message;
        container.style.display = "block";
      }
    }

    fetchLatestQuakeData();
    setInterval(fetchLatestQuakeData, 100);
  </script>
</body>
</html>
